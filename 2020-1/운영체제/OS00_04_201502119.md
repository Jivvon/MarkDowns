## 201502119 정지원

#### Producer-consumer 문제2

##### 변경 전

<img src="/Users/jiwon/Library/Application Support/typora-user-images/스크린샷 2020-06-01 오전 1.33.46.png" alt="스크린샷 2020-06-01 오전 1.33.46" style="zoom:80%;" />




소비자가 빈 버퍼에 접근하여 오류 발생

##### 코드 수정

```c
void *producer(void *args)
{
    int i;
    int producerID = ++producerCount;
    int item;

    for (i = 0; i < PRODUCE_TIME; i++)
    {
        item = (random() % 100) + producerID;
        usleep(item);

        /* 생산 세마포어 변수의 돌1개 소비 */
        sem_wait(&produce_ok);
        /**
         * 생산하는 도중에 소비자나 다른 생산자가 버퍼에 접근하지 못하도록 
         * 버퍼 세마포어 변수의 돌1개 소비
         */
        sem_wait(&buffer_lock);

        if (insertItem(item) == 0)
            printf("%s[PRODUCER_ERROR]insertItem Failed%s\n", T_RED, T_DEFAULT);
        else
            printf("%s producer %d add CQ %d%s\n", T_YELLOW, producerID, item, T_DEFAULT);

        /**
         * 생산이 끝나면 소비자나 다른 생산자가 버퍼에 접근할 수 있도록
         * 버퍼 세마포어 변수의 돌1개 생성
         */
        sem_post(&buffer_lock);
        /* 소비자가 소비할 수 있도록 소비 세마포어변수 돌1개 생성 */
        sem_post(&consume_ok);
    }
}

void *consumer(void *args)
{
    int i;
    int consumerID = ++consumerCount;
    int time;

    for (i = 0; i < CONSUME_TIME; i++)
    {
        int item;
        time = (random() % 100) + consumerID;
        usleep(time);

        /* 소비 세마포어변수 돌1개 소비 */
        sem_wait(&consume_ok);
        /**
         * 생산자나 다른 소비자가 버퍼에 접근하지 못하도록 
         * 버퍼 세마포어 변수의 돌1개 소비
         */
        sem_wait(&buffer_lock);

        if ((item = takeItem()) == -1)
            printf("%s[CONSUMER_ERROR]takeItem Failed%s\n", T_RED, T_DEFAULT);
        else
            printf("%s consumer %d take item from CQ %d%s\n", T_GREEN, consumerID, item, T_DEFAULT);

        /**
         * 생산자나 다른 소비자가 버퍼에 접근할 수 있도록 
         * 버퍼 세마포어 변수의 돌1개 생성
         */
        sem_post(&buffer_lock);
        /* 소비자가 버퍼 안의 물건을 하나 꺼내 소비했으므로 생산 세마포어 변수의 돌1개 생성 */
        sem_post(&produce_ok);
    }
}
```

생산자 코드와 소비자 코드를 위와 같이 수정하였다.

1. 생산자와 소비자는 생산/소비 세마포어를 1씩 감소한 후, 다른 생산자나 소비자가 버퍼에 접근하지 못하도록 버퍼 세마포어를 1 감소한다.
   - 버퍼 세마포어는 **초기값이 1**이다.
2. 생산/소비를 한 후 다른 생산자나 소비자가 버퍼에 접근할 수 있도록 버퍼 세마포어를 1 증가한다.
3. 1에서 감소했던 생산/소비 세마포어를 다시 1씩 증가한다.

##### 실행 결과

<img src="/Users/jiwon/Library/Application Support/typora-user-images/스크린샷 2020-06-01 오전 1.51.31.png" alt="스크린샷 2020-06-01 오전 1.51.31" style="zoom:50%;" />

빈 버퍼에 접근하여 오류가 발생하는 상황이 생기지 않는다.

세마포어를 사용하여 Producer-consumer 문제를 해결하였다 !

